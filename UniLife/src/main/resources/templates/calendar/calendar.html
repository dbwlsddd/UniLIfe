

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniLife - ì¼ì • ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100vw;
            height: 100vh;
            padding: 20px;
            background-color: #f4f4f4;
        }

        /* ìº˜ë¦°ë”ì™€ ì¼ì • ëª©ë¡ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ */
        #container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            width: 100%;
            max-width: 100vw;
        }

        /* ìº˜ë¦°ë” */
        #calendar {
            width: 50%;
            min-width: 500px;
            border: 1px solid #ddd;
            background-color: #fff;
            padding: 10px;
        }

        /* ì¼ì • ëª©ë¡ */
        #event-panel {
            width: 50%;
            min-width: 500px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 20px;
            background-color: #f9f9f9;
        }

        /* ì¼ì • í•­ëª© ìŠ¤íƒ€ì¼ */
        .event-item {
            padding: 8px;
            border-bottom: 1px solid #ddd;
        }

        .event-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- ìº˜ë¦°ë” -->
        <div id="calendar"></div>

        <!-- ì¼ì • íŒ¨ë„ -->
        <div id="event-panel">
            <h3>ğŸ“… ì¼ì • ëª©ë¡</h3>
            <ul id="event-list"></ul>
	
			<a href="/api/calendar/events/add" target="_blank" style="text-decoration: none;">
            <!-- ì¼ì • ì¶”ê°€ ë²„íŠ¼ -->
            <button onclick="openCenteredPopup('/api/calendar/events/add', 600, 400)" id="add-event-btn" style="display: none;">ì¼ì • ì¶”ê°€</button>
			</a>
			
            <!-- ì¼ì • ì¶”ê°€ í¼ -->
            <!--   <div id="event-form" style="display: none;">
                <h4>ì¼ì • ì¶”ê°€</h4>
                <label>ì œëª©: <input type="text" id="event-title"></label><br>
                <label>ì‹œê°„: <input type="time" id="event-time"></label><br>
                <label>ì¥ì†Œ: <input type="text" id="event-location"></label><br>
                <label><input type="checkbox" id="event-alert"> ì•Œë¦¼ ì„¤ì •</label><br>
                <button onclick="saveEvent()">ì €ì¥</button>
                <button onclick="closeForm()">ì·¨ì†Œ</button>
            </div> -->
        </div>
    </div>

    <script>
    let selectedDate = null;
    let calendar; // ì „ì—­ìœ¼ë¡œ ì„ ì–¸

    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            events: function(fetchInfo, successCallback, failureCallback) {
                const start = fetchInfo.startStr;
                const end = fetchInfo.endStr;

                fetch(`/api/calendar/events?start=${start}&end=${end}`)
                .then(response => response.json())
                .then(data => {
                    console.log("FullCalendar ì´ë²¤íŠ¸ ìˆ˜ì‹ :", data); // ğŸ‘ˆ ì´ê±°!
                    successCallback(data);
                })
                .catch(err => {
                    console.error("ì´ë²¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
                    failureCallback(err);
                });
            },

            selectable: true,
            editable: true,
            dateClick: function(info) {
                selectedDate = info.dateStr;
                loadEventListByDate(selectedDate);
                document.getElementById('add-event-btn').style.display = "block";
            }
        });

        calendar.render();
    });


    // ì¼ì • ì¶”ê°€ í¼ ì—´ê¸°
    document.getElementById('add-event-btn').addEventListener('click', function () {
        document.getElementById('event-form').style.display = "block";
    });

    // ì¼ì • ì¶”ê°€ í¼ ë‹«ê¸°
    function closeForm() {
        document.getElementById('event-form').style.display = "none";
    }

    // íŠ¹ì • ë‚ ì§œì˜ ì¼ì • ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ì˜¤ë¥¸ìª½ì— í‘œì‹œ)
    function loadEventListByDate(date) {
	    fetch(`/api/calendar/events/day?date=${date}`)  // ğŸ‘ˆ URL ë³€ê²½!
	        .then(response => response.json())
	        .then(events => {
	            const eventList = document.getElementById('event-list');
	            eventList.innerHTML = "";
	            events.forEach(event => {
	                const li = document.createElement('li');
	                li.innerHTML = `
	                    ${event.title} (${event.start}) 
	                    <button onclick="deleteEvent(${event.id})">ì‚­ì œ</button>
	                    <button onclick="openEditPopup(${event.id})">ìˆ˜ì •</button>
	                `;
	                eventList.appendChild(li);
	            });
	        });
	}


    // ì¼ì • ì €ì¥
    function saveEvent() {
	    const title = document.getElementById('event-title').value;
	    const time = document.getElementById('event-time').value;
	    const location = document.getElementById('event-location').value;
	    const alert = document.getElementById('event-alert').checked;
	    const type = document.getElementById('event-type').value;
	    const color = document.getElementById('event-color').value;
	
	    if (!title || !selectedDate) {
	        alert("ì¼ì • ì œëª©ê³¼ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!");
	        return;
	    }
	
	    const eventData = {
	        title: title,
	        start: `${selectedDate}T${time}`,
	        location: location,
	        alert: alert,
	        type: type,
	        color: color
	    };
	
	    fetch('/events/add', {
	        method: 'POST',
	        headers: { 'Content-Type': 'application/json' },
	        body: JSON.stringify(eventData)
	    })
	    .then(response => response.json())
	    .then(data => {
	        alert(data.message);
	        closeForm();
	        loadEventListByDate(selectedDate);
	
	        // FullCalendarì— ë™ì ìœ¼ë¡œ ì¶”ê°€
	        calendar.addEvent({
	            title: `${eventData.title} (${eventData.type})`, // ì œëª©ì— íƒ€ì… í‘œì‹œ
	            start: eventData.start,
	            backgroundColor: eventData.color,
	            borderColor: eventData.color,
	            extendedProps: {
	                location: eventData.location,
	                alert: eventData.alert,
	                type: eventData.type
	            }
	        });
	    });
	}


    // íŒì—… ì°½ ì—´ê¸° í•¨ìˆ˜
    function openCenteredPopup(url, width, height) {
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;

        const left = (screenWidth - width) / 2;
        const top = (screenHeight - height) / 2;

        window.open(url, '_blank', `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);
    }

    // ì „ì²´ ì¼ì • ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ìº˜ë¦°ë”ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ (í•„ìš”ì‹œ ì‚¬ìš©)
    async function loadAllEventsToCalendar() {
        const response = await fetch('/api/calendar/events');
        const events = await response.json();

        events.forEach(event => {
            addEventToCalendar(event); // ì´ í•¨ìˆ˜ê°€ ìˆë‹¤ë©´ ì •ì˜ í•„ìš”
        });
    }

    // ìƒˆ ì¼ì • ì„œë²„ì— ì €ì¥í•˜ê³  ìº˜ë¦°ë”ì— ì¶”ê°€í•˜ëŠ” í•¨ìˆ˜ (í•„ìš”ì‹œ ì‚¬ìš©)
    async function addNewEvent(eventData) {
        const response = await fetch('/api/calendar/events/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(eventData)
        });

        if (response.ok) {
            const event = await response.json();
            addEventToCalendar(event); // ì´ í•¨ìˆ˜ê°€ ìˆë‹¤ë©´ ì •ì˜ í•„ìš”
        }
    }
    
    function deleteEvent(eventId) {
        if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        fetch(`/api/calendar/events/${eventId}`, {
            method: 'DELETE'
        })
        .then(response => {
            if (response.ok) {
                alert("ì‚­ì œ ì„±ê³µ!");
                loadEventListByDate(selectedDate); // ì˜¤ë¥¸ìª½ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                calendar.refetchEvents(); // ìº˜ë¦°ë” ì´ë²¤íŠ¸ ìƒˆë¡œê³ ì¹¨
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨!");
            }
        });
    }
    
    function openEditPopup(eventId) {
        window.open(`/api/calendar/events/edit/${eventId}`, '_blank', 'width=600,height=500,top=100,left=100');
    }

</script>

</body>
</html>